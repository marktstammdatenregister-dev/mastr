#!/usr/bin/env bash

set -Eeuxo pipefail

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
BASE_DIR="${SCRIPT_DIR}/../.."

cd "${BASE_DIR}/web"
mkdir 'validierung'
pushd 'validierung'

rclone copy --include 'Gesamtdatenexport_*.json' 'wasabi:mastr-validation-1' . --config "${BASE_DIR}/build/rclone.conf"

for f in Gesamtdatenexport_*.json; do
  BASE="${f%.json}"
  mustache "${BASE}.json" ../template/Report.de.html.mustache >"${BASE}.html"
done

ls "*.html" |
  sort --reverse |
  jq --raw-input . |
  jq --slurp '{Reports: . | map({ExportName: (.[:-5]), FileName: .})}' \
    >index.json
mustache index.json ../template/Index.de.html.mustache >index.html

popd # 'validierung'

tar -cvz . >/tmp/site.tar.gz
curl --oauth2-bearer "${SRHT_SITE_OAUTH2_TOKEN}" -Fcontent=@/tmp/site.tar.gz https://pages.sr.ht/publish/marktstammdatenregister.dev
