name: Publish site
on:
  workflow_dispatch:         # Enable manual trigger
env:
  SRHT_SITE_OAUTH2_TOKEN: ${{secrets.SRHT_SITE_OAUTH2_TOKEN}}
  RCLONE_CONFIG_WASABI_ACCESS_KEY_ID: ${{secrets.RCLONE_CONFIG_WASABI_ACCESS_KEY_ID}}
  RCLONE_CONFIG_WASABI_SECRET_ACCESS_KEY: ${{secrets.RCLONE_CONFIG_WASABI_SECRET_ACCESS_KEY}}

jobs:
  publish-site:
    runs-on: ubuntu-latest
    steps:

    - name: Check out code
      uses: actions/checkout@v2

    - name: Install packages
      run: |
        set -Eeuxo pipefail

        sudo apt-get -qq update
        sudo apt-get -qq install axel brotli jq rclone

        # ruby-mustache does not handle zero as an empty value for the purpose of {#IntValue}...{/IntValue} blocks.
        curl -sSLo mustache.tar.gz https://github.com/cbroglie/mustache/releases/download/v1.3.1/mustache_1.3.1_linux_amd64.tar.gz
        tar -xvzf mustache.tar.gz mustache
        sudo mv mustache /usr/bin/mustache
        rm mustache.tar.gz

        jq --version
        rclone --version

    - name: Update site
      run: ./build/ci/publish-site
